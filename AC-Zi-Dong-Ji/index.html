
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AC自动机再放送 - Light up the sky</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="AC自动机AC 自动机可以理解为在多个串上的 KMP，利用 Trie 树来维护这些串，nxt 数组变为 fail 指针。
fail 指针的构造思想如下：
考虑 Trie 树中当前的节点 $u$，$u,"> 
    <meta name="author" content="RevolutionBP"> 
    <link rel="alternative" href="atom.xml" title="Light up the sky" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="AC自动机再放送 - Light up the sky"/>
    <meta name="twitter:description" content="AC自动机AC 自动机可以理解为在多个串上的 KMP，利用 Trie 树来维护这些串，nxt 数组变为 fail 指针。
fail 指针的构造思想如下：
考虑 Trie 树中当前的节点 $u$，$u,"/>
    
    
    
    
    <meta property="og:site_name" content="Light up the sky"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="AC自动机再放送 - Light up the sky"/>
    <meta property="og:description" content="AC自动机AC 自动机可以理解为在多个串上的 KMP，利用 Trie 树来维护这些串，nxt 数组变为 fail 指针。
fail 指针的构造思想如下：
考虑 Trie 树中当前的节点 $u$，$u,"/>
    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">Light up the sky</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://example.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">AC自动机再放送</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">AC自动机再放送</h1>
        <div class="stuff">
            <span>十一月 02, 2021</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E5%85%A5%E9%97%A8/" rel="tag">入门</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/" rel="tag">字符串</a></li></ul>


        </div>
        <div class="content markdown">
            <h2 id="AC自动机"><a href="#AC自动机" class="headerlink" title="AC自动机"></a>AC自动机</h2><p>AC 自动机可以理解为在多个串上的 KMP，利用 Trie 树来维护这些串，nxt 数组变为 fail 指针。</p>
<p>fail 指针的构造思想如下：</p>
<p>考虑 Trie 树中当前的节点 $u$，$u$ 的父节点是 $p$，$p$ 通过字符 $c$ 的边指向 $u$，即 $\text{trie}[p,c]=u$。假设深度小于 $u$ 的所有节点的 $\text{fail}$ 指针都已求得。</p>
<p>1.如果 $\text{trie}[\text{fail}[p],c]$ 存在，则让 $u$ 的 fail 指针指向 trie[fail[p], c]。相当于在 $p$ 和 $\text{fail}[p]$ 后面加一个字符 $c$，分别对应 $u$ 和 $\text{fail}[u]$。</p>
<p>2.如果 trie[fail[p], c] 不存在，那么我们继续找到 trie[fail[fail[p]], c]，重复 1 的判断过程，一直跳 fail 指针直到根节点。</p>
<p>3.如果真的没有，就让 fail 指针指向根节点。</p>
<p>可以发现，AC 自动机与 KMP 是非常相似的。</p>
<p>这是基本思想，具体实现我们可以直接<strong>构造 Trie 图</strong>以进行多串匹配。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="普通实现"><a href="#普通实现" class="headerlink" title="普通实现"></a>普通实现</h4><p><strong>【模板】AC自动机（简单版）(luoguP3808)</strong></p>
<p>给定 $n$ 个模式串 $s_i$ 和一个文本串 $t$，求有多少个不同的模式串在文本串里出现过，两个模式串不同当且仅当它们编号不同。</p>
<p>$1\le n\le10^6$，$1\le|t|\le10^6$，$1\le\sum_{i=1}^n|s_i|\le10^6$。</p>
<hr>
<p><strong>1 在 Trie 树上插入各串</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            tr[pos][tmp] = ++ct;</span><br><span class="line">        pos = tr[pos][tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    val[pos] ++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2 fail指针的构建</strong></p>
<p>按照上面的思路进行构建</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="built_in">memset</span>(fail, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(fail));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tr[<span class="number">0</span>][i])	<span class="comment">// 0 是根节点，后面 while(tmp &amp;&amp; ...) 其实前者是 tmp != rt</span></span><br><span class="line">            q.<span class="built_in">push</span>(tr[<span class="number">0</span>][i]);	<span class="comment">// 从根节点的子节点开始，类似于 KMP 从 2 开始</span></span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(tr[x][i]) &#123;	<span class="comment">// 匹配现在的</span></span><br><span class="line">                <span class="keyword">int</span> tmp = fail[x];</span><br><span class="line">                <span class="keyword">while</span>(tmp &amp;&amp; tr[tmp][i] == <span class="number">0</span>)	<span class="comment">// 没匹配上，往回跳</span></span><br><span class="line">                    tmp = fail[tmp];</span><br><span class="line">                <span class="keyword">if</span>(tr[tmp][i])	<span class="comment">// fail 指针那边的也有 i 这个字符，匹配上了</span></span><br><span class="line">                    tmp = tr[tmp][i];</span><br><span class="line">                fail[tr[x][i]] = tmp;</span><br><span class="line">                q.<span class="built_in">push</span>(tr[x][i]);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3 多模式匹配</strong></p>
<p>多个模式串对文本串的匹配。</p>
<p>如果能匹配，就匹配，不能匹配，就跳 fail，注意可能多次匹配，所以要去掉重复匹配的贡献。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">while</span>(pos &amp;&amp; tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            pos = fail[pos];</span><br><span class="line">        <span class="keyword">if</span>(tr[pos][tmp])</span><br><span class="line">            pos = tr[pos][tmp];</span><br><span class="line">        ret += val[pos];</span><br><span class="line">        val[pos] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1000010</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> s[N];</span><br><span class="line"><span class="keyword">int</span> ct, tr[N][<span class="number">26</span>], val[N], fail[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            tr[pos][tmp] = ++ct;</span><br><span class="line">        pos = tr[pos][tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    val[pos] ++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tr[<span class="number">0</span>][i]) &#123;</span><br><span class="line">            fail[tr[<span class="number">0</span>][i]] = <span class="number">0</span>;</span><br><span class="line">            q.<span class="built_in">push</span>(tr[<span class="number">0</span>][i]);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(tr[x][i]) &#123;</span><br><span class="line">                <span class="keyword">int</span> tmp = fail[x];</span><br><span class="line">                <span class="keyword">while</span>(tmp &amp;&amp; tr[tmp][i] == <span class="number">0</span>)</span><br><span class="line">                    tmp = fail[tmp];</span><br><span class="line">                <span class="keyword">if</span>(tr[tmp][i])</span><br><span class="line">                    tmp = tr[tmp][i];</span><br><span class="line">                fail[tr[x][i]] = tmp;</span><br><span class="line">                q.<span class="built_in">push</span>(tr[x][i]);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">while</span>(pos &amp;&amp; tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            pos = fail[pos];</span><br><span class="line">        <span class="keyword">if</span>(tr[pos][tmp])</span><br><span class="line">            pos = tr[pos][tmp];</span><br><span class="line">        ret += val[pos];</span><br><span class="line">        val[pos] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">Insert</span>(s+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">query</span>(s+<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="Trie图的构建"><a href="#Trie图的构建" class="headerlink" title="Trie图的构建"></a>Trie图的构建</h4><p>建出真实的边，使 Trie 树变为一张图。</p>
<p>具体而言，只要把儿子记录上即可。</p>
<p>复杂度 $O(|S|\times n)$，$|S|$ 是字符集大小。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(t[rt][i]) &#123;</span><br><span class="line">            q.<span class="built_in">push</span>(t[rt][i]);</span><br><span class="line">            fail[t[<span class="number">0</span>][i]] = rt;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(t[x][i]) &#123;</span><br><span class="line">                fail[t[x][i]] = t[fail[x]][i];</span><br><span class="line">                q.<span class="built_in">push</span>(t[x][i]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                t[x][i] = t[fail[x]][i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释：</p>
<p>对于 <code>else</code> 部分，相当于直接把这个不存在的儿子接到其失配指针的这个儿子，如果失配指针也没有这个儿子呢？那么它一定也通过 <code>else</code> 接上了可能的儿子，所以可以保证接上的恰好是一个最优的位置。</p>
<p>对于 <code>if</code> 部分，类似地，假如它的父亲（$x$）有 $i$ 这个儿子，相当于直接匹配，那么显然是对的，如果没有，等同于 <code>else</code> 部分的解释，它一定指向了一个最优的位置。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        pos = tr[pos][tmp];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = pos; j &gt; <span class="number">0</span> &amp;&amp; val[j] != <span class="number">-1</span>; j = fail[j]) &#123;  <span class="comment">// 由于打标记后 j = fail[j] 仍然会进行下去，所以一直到根节点全都打了标记，所以如果再次走到这个位置可以直接退出</span></span><br><span class="line">            ret += val[j];</span><br><span class="line">            val[j] = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1000010</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> s[N];</span><br><span class="line"><span class="keyword">int</span> ct, tr[N][<span class="number">26</span>], val[N], fail[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            tr[pos][tmp] = ++ct;</span><br><span class="line">        pos = tr[pos][tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    val[pos] ++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tr[<span class="number">0</span>][i])</span><br><span class="line">            q.<span class="built_in">push</span>(tr[<span class="number">0</span>][i]);</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(tr[x][i]) &#123;</span><br><span class="line">                fail[tr[x][i]] = tr[fail[x]][i];</span><br><span class="line">                q.<span class="built_in">push</span>(tr[x][i]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                tr[x][i] = tr[fail[x]][i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        pos = tr[pos][tmp];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = pos; j &gt; <span class="number">0</span> &amp;&amp; val[j] != <span class="number">-1</span>; j = fail[j]) &#123;  <span class="comment">// 由于打标记后 j = fail[j] 仍然会进行下去，所以一直到根节点全都打了标记，所以如果再次走到这个位置可以直接退出</span></span><br><span class="line">            ret += val[j];</span><br><span class="line">            val[j] = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">Insert</span>(s+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="built_in">query</span>(s+<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>另外一个模板</strong></p>
<p><strong>【模板】AC自动机（加强版）(luoguP3796)</strong></p>
<p>有 $N$ 个由小写字母组成的模式串以及一个文本串 $T$，找出哪些模式串在文本串 $T$ 中出现的次数最多。</p>
<p>$1\le N\le 150$，单个模式串长度 $\le70$，文本串长度 $\le10^6$。</p>
<hr>
<p>由于 Trie 数每个节点表示的字符串具有唯一性，并且 AC 自动机每到达一个位置就表示和当前位置表示的字符串匹配了，我们可以这么做：</p>
<p>记录每个模式串结尾位置，匹配时每到一个位置就累加这个位置的模式串出现次数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">20010</span>, M = <span class="number">1000010</span>, H = <span class="number">80</span>, P = <span class="number">160</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> s[M];</span><br><span class="line"><span class="keyword">char</span> str[P][H];</span><br><span class="line"><span class="keyword">int</span> ct, t[N][<span class="number">26</span>], fail[N], ed[N];</span><br><span class="line"><span class="keyword">int</span> tim[P]; <span class="comment">// 各个串的匹配次数</span></span><br><span class="line"><span class="keyword">int</span> top, stk[P], maxtim;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">int</span> rk)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(t[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            t[pos][tmp] = ++ct;</span><br><span class="line">        pos = t[pos][tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    ed[pos] = rk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(t[<span class="number">0</span>][i])</span><br><span class="line">            q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(t[x][i]) &#123;</span><br><span class="line">                fail[t[x][i]] = t[fail[x]][i];</span><br><span class="line">                q.<span class="built_in">push</span>(t[x][i]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                t[x][i] = t[fail[x]][i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        pos = t[pos][tmp];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = pos; j; j = fail[j])</span><br><span class="line">            tim[ed[j]] ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solv</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, str[i]+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">Insert</span>(str[i]+<span class="number">1</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">query</span>(s+<span class="number">1</span>);</span><br><span class="line">    maxtim = <span class="number">0</span>;</span><br><span class="line">    top = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tim[i] &gt; maxtim) &#123;</span><br><span class="line">            maxtim = tim[i];</span><br><span class="line">            top = <span class="number">0</span>;</span><br><span class="line">            stk[++top] = i;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(tim[i] == maxtim)</span><br><span class="line">            stk[++top] = i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, maxtim);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= top; i ++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str[stk[i]] + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">clea</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(ed, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(ed));</span><br><span class="line">    <span class="built_in">memset</span>(fail, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(fail));</span><br><span class="line">    ct = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(t, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(t));</span><br><span class="line">    <span class="built_in">memset</span>(tim, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(tim));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">solv</span>();</span><br><span class="line">        <span class="built_in">clea</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Fail树"><a href="#Fail树" class="headerlink" title="Fail树"></a>Fail树</h3><p>Fail 指针构成了一个树形结构。</p>
<p>1.除了根节点都有 Fail 指针。</p>
<p>2.各个节点都能跳到根。</p>
<p>3.所以有 $N$ 个点 $N-1$ 条边，且连通，所以是树。</p>
<p><strong>【模板】AC自动机（二次加强版）(luoguP5357)</strong></p>
<p>给定一个文本串 $S$ 和 $n$ 个模式串 $T_{1\sim n}$，请你分别求出每个模式串 $T_i$ 在 $S$ 中出现的次数。</p>
<p>不保证任意两个模式串不同。</p>
<p>$1\le n\le2\times10^5$，$\sum_{i=1}^n|T_i|\le2\times10^5$，$|S|\le2\times10^6$。</p>
<hr>
<p>观察一下代码片段：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    pos = t[pos][tmp];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = pos; j; j = fail[j])</span><br><span class="line">        tim[ed[j]] ++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现一个问题，就是 <code>j</code> 循环的部分，跳 <code>fail[j]</code> 实际上复杂度是不确定的，深度可能很深，复杂度会退化。</p>
<p>但是我们发现其实每次转移是类似的，可以建立出 <code>fail</code> 树然后通过遍历一遍 <code>fail</code> 树将所有转移都做了。</p>
<p>具体地，<code>j</code> 恰好使一个链都 <code>++</code>，于是我们可以在底端打一个标记，然后构建 <code>fail</code> 树后在树上做 DP 向上传递并累加。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">200010</span>, M = <span class="number">2000010</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">char</span> s[M];</span><br><span class="line"><span class="keyword">int</span> ct, t[N][<span class="number">26</span>], fail[N];</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt; ed[N];</span><br><span class="line"><span class="keyword">int</span> ans[N];</span><br><span class="line"><span class="keyword">int</span> ctb, hd[N], ver[N&lt;&lt;<span class="number">1</span>], nxt[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line"><span class="keyword">int</span> f[N];   <span class="comment">// 树形 DP</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">    ver[++ctb] = v;</span><br><span class="line">    nxt[ctb] = hd[u];</span><br><span class="line">    hd[u] = ctb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *str, <span class="keyword">int</span> rk)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = str[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(t[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            t[pos][tmp] = ++ct;</span><br><span class="line">        pos = t[pos][tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    ed[pos].<span class="built_in">push_back</span>(rk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(t[<span class="number">0</span>][i])</span><br><span class="line">            q.<span class="built_in">push</span>(t[<span class="number">0</span>][i]);</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(t[x][i]) &#123;</span><br><span class="line">                fail[t[x][i]] = t[fail[x]][i];</span><br><span class="line">                q.<span class="built_in">push</span>(t[x][i]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                t[x][i] = t[fail[x]][i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> *str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        pos = t[pos][tmp];</span><br><span class="line">        f[pos] ++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = hd[x]; i; i = nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">int</span> y = ver[i];</span><br><span class="line">        <span class="keyword">if</span>(y == fa)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(y, x);</span><br><span class="line">        f[x] += f[y];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> tmpsiz = ed[x].<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmpsiz; i ++)</span><br><span class="line">        ans[ed[x][i]] += f[x];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">        <span class="built_in">Insert</span>(s, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">    <span class="built_in">query</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= ct; i ++) &#123;</span><br><span class="line">        <span class="built_in">add</span>(i, fail[i]);</span><br><span class="line">        <span class="built_in">add</span>(fail[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dfs</span>(<span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans[i]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><h4 id="阿狸的打字机-NOI2011-luoguP2414"><a href="#阿狸的打字机-NOI2011-luoguP2414" class="headerlink" title="阿狸的打字机 (NOI2011) (luoguP2414)"></a>阿狸的打字机 (NOI2011) (luoguP2414)</h4><p>有一个打字机，有 $28$ 个按键，分别是 $26$ 个小写英文字母和 <code>B</code>、<code>P</code> 两个字母，打字机是这样工作的：</p>
<ul>
<li>输入小写字母，会把这个字母加在凹槽最后。</li>
<li>按下 <code>B</code>，凹槽中的最后一个字母会消失</li>
<li>按下 <code>P</code>，会打印出凹槽中的字母，并换行，但凹槽中的字母不会消失</li>
</ul>
<p>给定一个字符串，表示按键情况。</p>
<p>然后把打印出来的字符串按照 $1\sim n$ 编号，有 $m$ 组询问，每次给定一个 $(x,y)$ 表示询问第 $x$ 个打印的字符串在第 $y$ 个打印的字符串中出现了多少次。</p>
<p>$1\le n\le10^5$，$1\le m\le10^5$，表示按键情况的字符串长度 $\le10^5$。</p>
<hr>
<p>最暴力的做法自然是跑 $m$ 遍 KMP，复杂度 $O(nm)$，是不能接受的。</p>
<p>本题的特点就在于它是由打字机打出来的，由于按键次数至多 $10^5$ 次，所以打出来的字符串相差必然都比较小。</p>
<p>如果放到 Trie 树上，必然不超过 $10^5$ 个节点。</p>
<p>我们想到构建 AC 自动机。</p>
<p>类似于 KMP，如果一个 fail 指针是从 $x$ 指向 $y$ 的，那么字符串 $y$ 在字符串 $x$ 中出现了一次。</p>
<p>对于一个字符串，从根到叶子，一路上每个节点都跳 fail 对应出来的若干个字符串全都在这个字符串内，并且不会漏，当然注意还要加上恰好就在这个串里的，即一路过来的这些子串。</p>
<p>于是我们可以在 Trie 树上 DFS，用一个全局桶，到每个节点跳 fail 把该加的都加进来。</p>
<p><del>然后光荣地 TLE 了。</del></p>
<p>跳 fail 复杂度是不对的，但是我们已经找到了策略，如何保证复杂度呢？</p>
<p>然后这时发现了一个问题，就是构建 AC 自动机太慢了，如果模拟的话，可能会插入许多许多次相同但很长的字符串，导致爆炸，于是我们需要特化本题的插入函数。</p>
<p>具体地，仍然是模拟，但是不从头插了，而是在 Trie 图上走，就可以保证复杂度。</p>
<p>然后我们就可以继续思考如何解决不可跳 fail 的问题。</p>
<p>分析可以发现，我们复杂度瓶颈在于一路上把各种串都插到桶里了，但是我们要查询的却比较少，于是我们考虑一对查询 $(x,y)$ 的关系。</p>
<p>按照上面的想法，就是 Trie 树上从根到 $y$ 一路上的点全插进来，fail 指针对应在 fail 树上的一条链全插进来，然后判断指向 $x$ 的个数，我们反向思考可以发现，只有 fail 树上 $x$ 的子树内的才能指向它，而且发现是一条链上全有贡献，所以子树内全都有贡献，于是我们每次不要跳 fail 到根，而是仅打一个标记，然后查 $x$ 只需要查 $x$ 子树内的标记数目。</p>
<p>然后这个东西可以数据结构优化，子树可以通过 DFS 序化为区间，然后就是单点修改区间查询。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>;</span><br><span class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; pii;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> m, ct, tr[N][<span class="number">26</span>], tmptr[N][<span class="number">26</span>], fail[N];</span><br><span class="line"><span class="keyword">char</span> s[N];</span><br><span class="line"><span class="keyword">int</span> ctb, top, stk[N];</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt; strk[N];    <span class="comment">// 各个点对应的串的编号们</span></span><br><span class="line">vector&lt;pii&gt; qry[N];    <span class="comment">// 各个点的询问，第二关键字为询问序号</span></span><br><span class="line"><span class="keyword">int</span> p[N];   <span class="comment">// 第 i 个串在 Trie 中的位置</span></span><br><span class="line"><span class="keyword">int</span> cnt[N]; <span class="comment">// 全局桶，记录各个串出现次数，为了处理恰好就在这个串里的情况</span></span><br><span class="line"><span class="keyword">int</span> ans[N];</span><br><span class="line"><span class="keyword">int</span> ctc, hd[N], ver[N&lt;&lt;<span class="number">1</span>], nxt[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line"><span class="keyword">int</span> ctd, dfn[N], siz[N];</span><br><span class="line"><span class="keyword">int</span> t[N];   <span class="comment">// BIT</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">    ver[++ctc] = v;</span><br><span class="line">    nxt[ctc] = hd[u];</span><br><span class="line">    hd[u] = ctc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(str[i] &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; str[i] &lt;= <span class="string">&#x27;z&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> tmp = str[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">                tr[pos][tmp] = ++ct;</span><br><span class="line">            stk[++top] = tr[pos][tmp];</span><br><span class="line">            pos = tr[pos][tmp];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(str[i] == <span class="string">&#x27;B&#x27;</span>) &#123;</span><br><span class="line">            top --;</span><br><span class="line">            pos = stk[top];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(str[i] == <span class="string">&#x27;P&#x27;</span>) &#123;</span><br><span class="line">            ++ ctb;</span><br><span class="line">            strk[pos].<span class="built_in">push_back</span>(ctb);</span><br><span class="line">            p[ctb] = pos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(tmptr, tr, <span class="built_in"><span class="keyword">sizeof</span></span>(tr));</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tmptr[<span class="number">0</span>][i]) &#123;</span><br><span class="line">            q.<span class="built_in">push</span>(tmptr[<span class="number">0</span>][i]);</span><br><span class="line">            fail[tmptr[<span class="number">0</span>][i]] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(tmptr[x][i]) &#123;</span><br><span class="line">                fail[tmptr[x][i]] = tmptr[fail[x]][i];</span><br><span class="line">                q.<span class="built_in">push</span>(tmptr[x][i]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                tmptr[x][i] = tmptr[fail[x]][i];    <span class="comment">// 这种方法会影响 Trie 树结构，所以我们需要新建一个副本来构建 fail 指针</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> dlt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(; pos &lt;= ct+<span class="number">1</span>; pos += pos &amp; (-pos)) <span class="comment">// 注意有 ct+1 个点！</span></span><br><span class="line">        t[pos] += dlt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">subquery</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; pos; pos -= pos &amp; (-pos))</span><br><span class="line">        ret += t[pos];</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">subquery</span>(r) - <span class="built_in">subquery</span>(l<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfsa</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> fa)</span> </span>&#123;  <span class="comment">// 给 fail 树标 dfn 标记并求出辅助的一些量</span></span><br><span class="line">    siz[x] = <span class="number">1</span>;</span><br><span class="line">    dfn[x] = ++ctd;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = hd[x]; i; i = nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">int</span> y = ver[i];</span><br><span class="line">        <span class="keyword">if</span>(y == fa)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfsa</span>(y, x);</span><br><span class="line">        siz[x] += siz[y];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfsb</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tmpsiz = strk[x].<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmpsiz; i ++)</span><br><span class="line">    	cnt[strk[x][i]] ++; <span class="comment">// 把当前串插入桶</span></span><br><span class="line">    <span class="built_in">modify</span>(dfn[fail[x]], <span class="number">1</span>);    <span class="comment">// 打标记</span></span><br><span class="line">    tmpsiz = qry[x].<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmpsiz; i ++) &#123;</span><br><span class="line">        pii ttmp = qry[x][i];</span><br><span class="line">        ans[ttmp.second] = cnt[ttmp.first] + <span class="built_in">query</span>(dfn[p[ttmp.first]], dfn[p[ttmp.first]] + siz[p[ttmp.first]] - <span class="number">1</span>);    <span class="comment">// 得到答案</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tr[x][i])</span><br><span class="line">            <span class="built_in">dfsb</span>(tr[x][i]); <span class="comment">// dfs</span></span><br><span class="line">    tmpsiz = strk[x].<span class="built_in">size</span>();   <span class="comment">// 回溯时撤回</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmpsiz; i ++)</span><br><span class="line">        cnt[strk[x][i]] --;</span><br><span class="line">    <span class="built_in">modify</span>(dfn[fail[x]], <span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">Insert</span>(s+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">build</span>();</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;m);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>, tx, ty; i &lt;= m; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;tx, &amp;ty);</span><br><span class="line">        qry[p[ty]].<span class="built_in">push_back</span>(<span class="built_in">make_pair</span>(tx, i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= ct; i ++) &#123;</span><br><span class="line">        <span class="built_in">addedge</span>(i, fail[i]);</span><br><span class="line">        <span class="built_in">addedge</span>(fail[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dfsa</span>(<span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">dfsb</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i ++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans[i]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="魔法咒语-BJOI2017-luoguP3715"><a href="#魔法咒语-BJOI2017-luoguP3715" class="headerlink" title="魔法咒语 (BJOI2017) (luoguP3715)"></a>魔法咒语 (BJOI2017) (luoguP3715)</h4><p>给定 $n$ 个基本词汇，$m$ 个忌讳词语，它们都是字符串。求满足下列条件的字符串的个数：</p>
<p>1.长度等于 $L$。</p>
<p>2.可以被分割为若干个基本词汇。</p>
<p>3.不存在任何一个禁忌词语在字符串中出现过。</p>
<p>这里字符串不同的条件比较特殊：</p>
<p>把基本词汇标号 $1\sim n$，把字符串分割为若干个基本词汇，设 $i$ 号基本词汇的出现次数为 $c_i$，两个字符串不同当且仅当存在一个 $c_i$ 不相等。</p>
<p>而书写形式相同也可能是两个不同的字符串。</p>
<p>答案对 $10^9+7$ 取模。</p>
<p>$1\le n,m\le50$，$1\le L\le10^8$，当 $L&gt;100$ 时，保证基本词汇长度不超过 $2$，$M\le20$。</p>
<p>基本词汇长度之和、忌讳词语的长度之和不超过 $100$，基本词汇不重复，禁忌词汇不重复。</p>
<hr>
<p>由于字符串中不能出现忌讳词语，而判断是否出现忌讳词语就相当于匹配这个忌讳词语，容易想到要把所有忌讳词语插入 AC 自动机。</p>
<p>然后构建 fail 树并把所有不能到达的点做标记，然后在 AC 自动机上 DP，每次考虑加入一个基本词汇，然后枚举可以转移到的状态，为了使复杂度更优秀，我们可以 $O(n^3)$ 暴力预处理每个点插入每个字符串会到达的点，这样把我们 DP 的复杂度从 $O(L\times n^3)$ 优化到了 $O(L\times n^2)$。</p>
<p>这样，我们就解决了第一部分，本题另外一部分是 $L\le10^8$，但保证基本词汇长度不超过 $2$，这明显提示我们写矩乘。</p>
<p>这里已经不是这题在 AC 自动机方面作为例题的作用所在了，但还是说一下如何写吧。</p>
<p>主要还是建矩阵嘛。</p>
<p>设我们前面预处理那个数组是 $p[i][j]$，表示在点 $i$ 添加串 $j$ 到达的位置。转移都是形如下面这样的：</p>
<script type="math/tex; mode=display">
f[i][j]\rarr f[p[i][k]][j+l_k]</script><p>除了填完填了一位时不能填长度为 $2$ 的串以外，其他时候，转移都是随便填，这样就是个常系数的递推。</p>
<p>设初始列向量为 $f[0\sim ct][1],f[0\sim ct][0]$，然后矩阵的前 $ct+1$ 行就是看是否有转移，后 $ct+1$ 行是继承旧的前半部分。</p>
<p>当然，看是否有转移其实麻烦了，因为那样就还需要一个逆映射，没有必要，我们有 $p$ 这个映射就够了，我们仍然枚举所有转移，然后寻找转移在矩阵上的位置就行了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100</span>, md = <span class="number">1000000007</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Matrix</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> n, m;</span><br><span class="line">    ll a[N&lt;&lt;<span class="number">1</span>][N&lt;&lt;<span class="number">1</span>];</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++)</span><br><span class="line">            a[i][i] = <span class="number">1ll</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> _n, <span class="keyword">int</span> _m)</span> </span>&#123;</span><br><span class="line">        n = _n;</span><br><span class="line">        m = _m;</span><br><span class="line">        <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(a));</span><br><span class="line">    &#125;</span><br><span class="line">    Matrix <span class="keyword">operator</span> * (Matrix B) &#123;</span><br><span class="line">        Matrix res;</span><br><span class="line">        res.<span class="built_in">init</span>(n, B.m);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= B.m; j ++)</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= m; k ++)</span><br><span class="line">                    res.a[i][j] = (res.a[i][j] + a[i][k] * B.a[k][j]) % md;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Matrix <span class="title">qpow</span><span class="params">(<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        Matrix res, mat = *<span class="keyword">this</span>;</span><br><span class="line">        res.<span class="built_in">init</span>(n, n);</span><br><span class="line">        res.<span class="built_in">id</span>();</span><br><span class="line">        <span class="keyword">for</span>(; b; b &gt;&gt;= <span class="number">1</span>, mat = mat * mat)</span><br><span class="line">            <span class="keyword">if</span>(b &amp; <span class="number">1</span>)</span><br><span class="line">                res = res * mat;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, m, l;</span><br><span class="line"><span class="keyword">char</span> s[N][N], tmps[N];</span><br><span class="line"><span class="keyword">int</span> len[N];</span><br><span class="line"><span class="keyword">int</span> ct, tr[N][<span class="number">26</span>], fail[N];</span><br><span class="line"><span class="keyword">bool</span> tag[N];    <span class="comment">// 忌讳词语标记</span></span><br><span class="line"><span class="keyword">int</span> ctb, hd[N], ver[N&lt;&lt;<span class="number">1</span>], nxt[N&lt;&lt;<span class="number">1</span>];</span><br><span class="line"><span class="keyword">int</span> p[N][N];   <span class="comment">// p[i][j] 表示在点 i，添加第 j 个串会到达哪里</span></span><br><span class="line"><span class="keyword">int</span> f[N][N]; <span class="comment">// 在点 i，填了 j 个字符的方案数</span></span><br><span class="line">Matrix st, trans;  <span class="comment">// 初始列向量，状态转移矩阵</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">    ver[++ctb] = v;</span><br><span class="line">    nxt[ctb] = hd[u];</span><br><span class="line">    hd[u] = ctb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i ++) &#123;</span><br><span class="line">        <span class="keyword">int</span> tmp = s[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(tr[pos][tmp] == <span class="number">0</span>)</span><br><span class="line">            tr[pos][tmp] = ++ct;</span><br><span class="line">        pos = tr[pos][tmp];</span><br><span class="line">    &#125;</span><br><span class="line">    tag[pos] = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildfail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    queue&lt;<span class="keyword">int</span>&gt; q;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">        <span class="keyword">if</span>(tr[<span class="number">0</span>][i])</span><br><span class="line">            q.<span class="built_in">push</span>(tr[<span class="number">0</span>][i]);</span><br><span class="line">    <span class="keyword">while</span>(q.<span class="built_in">empty</span>() == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = q.<span class="built_in">front</span>();</span><br><span class="line">        q.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">26</span>; i ++)</span><br><span class="line">            <span class="keyword">if</span>(tr[x][i]) &#123;</span><br><span class="line">                fail[tr[x][i]] = tr[fail[x]][i];</span><br><span class="line">                q.<span class="built_in">push</span>(tr[x][i]);</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">                tr[x][i] = tr[fail[x]][i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">buildfailtree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= ct; i ++) &#123;</span><br><span class="line">        <span class="built_in">addedge</span>(i, fail[i]);</span><br><span class="line">        <span class="built_in">addedge</span>(fail[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> fa, <span class="keyword">bool</span> flg)</span> </span>&#123;</span><br><span class="line">    flg |= tag[x];</span><br><span class="line">    tag[x] = flg;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = hd[x]; i; i = nxt[i]) &#123;</span><br><span class="line">        <span class="keyword">int</span> y = ver[i];</span><br><span class="line">        <span class="keyword">if</span>(y == fa)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">dfs</span>(y, x, flg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= ct; i ++) &#123; <span class="comment">// 预处理 p[i][j]</span></span><br><span class="line">        <span class="keyword">if</span>(tag[i])</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j ++) &#123;</span><br><span class="line">            <span class="keyword">int</span> pos = i;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">1</span>; k &lt;= len[j]; k ++) &#123;</span><br><span class="line">                <span class="keyword">int</span> tmp = s[j][k] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                pos = tr[pos][tmp];</span><br><span class="line">                <span class="keyword">if</span>(tag[pos]) &#123;</span><br><span class="line">                    p[i][j] = <span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(p[i][j] != <span class="number">-1</span>)</span><br><span class="line">                p[i][j] = pos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solv1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    f[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= l; i ++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j ++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i + len[j] &gt; l)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt;= ct; k ++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(tag[k] || p[k][j] == <span class="number">-1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                f[p[k][j]][i + len[j]] = (f[p[k][j]][i + len[j]] + f[k][i]) % md;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= ct; i ++)</span><br><span class="line">        ans = (ans + f[i][l]) % md;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">solv2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    f[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(len[i] &gt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= ct; j ++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(tag[j] || p[j][i] == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            f[p[j][i]][<span class="number">1</span>] = (f[p[j][i]][<span class="number">1</span>] + f[j][<span class="number">0</span>]) % md;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    st.<span class="built_in">init</span>(<span class="number">2</span>*(ct+<span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= ct+<span class="number">1</span>; i ++) &#123;   <span class="comment">// 初始列向量</span></span><br><span class="line">        st.a[i][<span class="number">1</span>] = f[i<span class="number">-1</span>][<span class="number">1</span>];</span><br><span class="line">        st.a[i+(ct+<span class="number">1</span>)][<span class="number">1</span>] = f[i<span class="number">-1</span>][<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    trans.<span class="built_in">init</span>(<span class="number">2</span>*(ct+<span class="number">1</span>), <span class="number">2</span>*(ct+<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = ct+<span class="number">2</span>; i &lt;= <span class="number">2</span>*ct+<span class="number">2</span>; i ++)    <span class="comment">// 下边直接继承的部分</span></span><br><span class="line">        trans.a[i][i-(ct+<span class="number">1</span>)] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++)  <span class="comment">// 上边的部分</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= ct; j ++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(tag[j] || p[j][i] == <span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(len[i] == <span class="number">1</span>)</span><br><span class="line">                trans.a[p[j][i] + <span class="number">1</span>][j+<span class="number">1</span>] ++;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                trans.a[p[j][i] + <span class="number">1</span>][(j+<span class="number">1</span>) + (ct+<span class="number">1</span>)] ++;</span><br><span class="line">        &#125;</span><br><span class="line">    trans = trans.<span class="built_in">qpow</span>(l<span class="number">-1</span>);</span><br><span class="line">    st = trans * st;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= ct+<span class="number">1</span>; i ++)</span><br><span class="line">        ans = (ans + st.a[i][<span class="number">1</span>]) % md;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d%d&quot;</span>, &amp;n, &amp;m, &amp;l);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, s[i]+<span class="number">1</span>);</span><br><span class="line">        len[i] = <span class="built_in">strlen</span>(s[i]+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i ++) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, tmps);</span><br><span class="line">        <span class="built_in">Insert</span>(tmps);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">buildfail</span>();</span><br><span class="line">    <span class="built_in">buildfailtree</span>();</span><br><span class="line">    <span class="built_in">dfs</span>(<span class="number">0</span>, <span class="number">-1</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">getp</span>();</span><br><span class="line">    <span class="keyword">if</span>(l &lt;= <span class="number">100</span>)</span><br><span class="line">        <span class="built_in">solv1</span>();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">solv2</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title="0" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                        
                            <li title="1" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                </ul>
            
        </div>
        
    <div id="gitalk-container" class="comment link"
		data-enable="false"
        data-ae="false"
        data-ci=""
        data-cs=""
        data-r=""
        data-o=""
        data-a=""
        data-d="false"
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
        tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
        TeX: {  noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
        messageStyle: "none"
    });
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




</html>
